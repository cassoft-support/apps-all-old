Общее описание:

1. В директории tools есть файл bitrix24.php с классом Bitrix24. Этот класс умеет формировать запросы для общения с удаленным порталом.
Для запросов используется REST API битрикса. Передаются запросы с помощью curl.

2. В директории tools есть файл tools.php. В нем есть метод getBitrix24(), который создает экземпляр класса Bitrix24. При этом он проверяет,
не истек ли авторизационный код access_token, и если истек, то формирует запрос и получает новый код с использованием refresh_token. Актуальный код
записывается в экземпляр класса Bitrix24, вместе с другими параметрами для авторизации.

3. В директории tools есть файл с классом Bitrix24Entity для создания оберток над методами REST API битрикса.
От него надо наследовать свои классы. В эти классы надо вставить методы для работы с REST API битрикса.
Затем они будут обращаться к классу Bitrix24, который выполнит запрос.
Например можно создать файл bitrix24deal.php, а в нем класс Bitrix24Deal. В нем создать метод get().
Этот метод использует метод crm.deal.get REST API битрикса.

4. Пакетное получение данных
Для пакетного получение данных служит класс Bitrix24Batch (файл bitrix24batch.php)
Он собирает массив в запросами, а затем выполняет их. Если в списочном запросе окажется больше 50 элементов, то он сам выполнит следующие запросы
и выведет уже готовый результат.
Например функция addDealListCall добавляет в массив с запросами запрос на получение списка сделок и использует метод crm.deal.list REST API битрикса:
public function addDealListCall($id, array $orders = array(), array $select = array(), array $filter = array(), $start = null)
{
    $this->addCall($id, "crm.deal.list", array("start" => $start, "orders" => $orders, "select" => $select, "filter" => $filter));
}
Здесь $id - нужно чтобы отличить в пакете один запрос от другого и потом взять из пакета результат по этому $id
А все остальное, как и классе bitrix24deal.php, только добавляется $start для запросов если сделок окажется больше 50

5. Авторизация в облаке:
Для доступа к облачному порталу приложению во время запуска необходимо авторизоваться на обачном портале.
Когда приложение запускается не с облачного портала, а с ЕЦН, то оно авторизуется под тем пользователем, который его установил
(его данные сохраняются в хайблоке во время инсталляции). А когда оно запускается с облачного портала, то авторизуется под тем пользователем,
который его запустил а не установил.

------------------------------------------------------------------------------------------
Инсталляция приложения
1. В маркетплейсе создается приложение, указывается название пункта меню (так как это смешанное приложение 2 и 3 типа)
2. Указываются адрес для первоначальной установки (https://city.brokci.ru/pub/forCloud/test/getDealsFromCloud/install.php)
3. Указывается адрес с индексной страницей приложения (https://city.brokci.ru/pub/forCloud/test/getDealsFromCloud/index.php)
4. Нажимается кнопка протестировать, указывается адрес портала в облаке, куда нужно установить приложение.
5. После этого маркетплейс перебрасывает на указанный портал, где нужно авторизоваться под администратором, и появляется диалоговое
окно для установки приложения. После нажатия кнопки Установить, открывается фрейм со страницей
https://city.brokci.ru/pub/forCloud/test/getDealsFromCloud/install.php Эта страница грузится с портала ЕЦН.
На ней сформирована кнопка Установить, при нажатии на которую js получает авторизационные данные пользователя и отправляет их
на портал ЕЦН для записи в хайблок.


Отличие установки приложения 2 и 3 типа:
2 типа:
При установке открывается страница по адресу /install.php и на ней можно выполнить нужный js код. Например создать поля для сделок.
Затем можно получить авторизационные данные, и послать их в ЕЦН для записи в хайблок.
3 типа:
Во время установки страница по адресу /install.php только получает информация с авторизациоными данными и другой информацией.
Сама страница не открывается во фрейме

-------------------------------------------------------------------------------------------
Принцип работы приложения в фоновом режиме:
1. Создается экземпляр класса GetDealsFromCloud
2. Вызывается метод getAuthFromDB(), который берет данные для авторизации из хайблока и вызовает функцию checkB24Auth(), которая создает
экземпляр специального класса Bitrix24 для работы с запросами.
3. Если авторизация успешна, то можно вызвать метод getDeals()
Пример получения сделок есть в файле:
/local/lib/classes/getDealsFromCloud/test.php
-------------------------------------------------------------------------------------------
Принцип проверки актуальности кода авторизации и запрос нового кода
1. Метод getBitrix24() в файле tools.php после создания объекта класса Bitrix24 проверяет актуальность кода для авторизации с помощью метода
$obB24App->isAccessTokenExpire();
Этот метод просто отправляет запрос на сервер и принимает ответ: $url = 'https://'.$domain."/rest/methods.json?auth=".$accessToken.'&full=true';
2. Если код недействителен, то Метод getBitrix24() получает новый код с помощью метода
$obB24App->getNewAccessToken();
Этот метод просто отправляет запрос на сервер https://oauth.bitrix.info/oauth/token/
Раньше запрос был на тот сервер, на котором проверялась актуальность кода но он не работал, я переделал на сервер https://oauth.bitrix.info/oauth/token/

-------------------------------


